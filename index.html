<!doctype html>
<html lang="fr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculateur de Rémunération des Élus Municipaux</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body { box-sizing: border-box; }
    :root {
      --bleu-fonce: #111F49;
      --blanc: #FFFFFF;
      --bleu-clair: #38B6FF;
      --bleu-ciel: #F0F7FB;
    }
    .calculator-card { transition: all 0.3s ease; }
    .calculator-card:hover { transform: translateY(-2px); }
    .result-animation { animation: slideIn 0.5s ease-out; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slider {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #d3d3d3;
      outline: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #38B6FF;
      cursor: pointer;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-[#F0F7FB] font-sans">
  <div class="max-w-4xl mx-auto px-4 py-8">
   <section>
    <div class="bg-white rounded-xl shadow-lg p-8 calculator-card">
     <div class="mb-8">
      <h2 class="text-3xl font-bold text-[#111F49] mb-4">Calculateur de Rémunération des Élus</h2>
      <p class="text-lg text-gray-600">Calcul des indemnités avec majorations automatiques et gestion de l'enveloppe globale.</p>
     </div>
     <form onsubmit="calculateRemuneration(event)" class="space-y-6">
      <div>
        <label for="population" class="block text-lg font-medium text-gray-700 mb-3"> Population municipale </label> 
        <input type="number" id="population" name="population" min="1" class="w-full px-6 py-4 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ex: 15000" required>
      </div>
      <button type="submit" class="w-full bg-[#38B6FF] text-white py-4 px-8 rounded-lg font-medium text-lg hover:opacity-90 transition-colors"> Calculer les indemnités </button>
     </form>
     
     <div id="advanced-mode-toggle" class="mt-4 text-center hidden">
       <button id="toggle-advanced-btn" onclick="toggleAdvancedMode()" class="px-6 py-2 rounded-lg font-medium text-sm transition-all border-2 border-blue-400 text-blue-600 hover:bg-blue-50"> Basculer vers le mode avancé </button>
     </div>

     <div id="result-remuneration" class="mt-8 hidden"></div>
    </div>
   </section>
  </div>

  <script>
    const remunerationData = {
      maire: [
        { max: 499, montant: 1048.18 }, { max: 999, montant: 1656.54 },
        { max: 3499, montant: 2121.03 }, { max: 9999, montant: 2260.79 },
        { max: 19999, montant: 2671.84 }, { max: 49999, montant: 3699.47 },
        { max: 99999, montant: 4521.58 }, { max: Infinity, montant: 5960.26 }
      ],
      adjoint: [
        { max: 499, montant: 406.94 }, { max: 999, montant: 439.83 },
        { max: 3499, montant: 813.88 }, { max: 9999, montant: 904.32 },
        { max: 19999, montant: 1130.39 }, { max: 49999, montant: 1356.47 },
        { max: 99999, montant: 1808.63 }, { max: 199999, montant: 2712.95 },
        { max: Infinity, montant: 2980.13 }
      ]
    };

    const conseillersTranches = [
      { max: 99, nb: 7 }, { max: 499, nb: 11 }, { max: 1499, nb: 15 },
      { max: 2499, nb: 19 }, { max: 3499, nb: 23 }, { max: 4999, nb: 27 },
      { max: 9999, nb: 29 }, { max: 19999, nb: 33 }, { max: 29999, nb: 35 },
      { max: Infinity, nb: 69 }
    ];

    let advancedMode = false;
    let currentData = null;

    function calculateRemuneration(event) {
      if(event) event.preventDefault();
      const population = parseInt(document.getElementById('population').value);
      
      let ratioAuto = 1.0;
      let labelAuto = "";
      if (population < 1000) { ratioAuto = 1.10; labelAuto = "10%"; }
      else if (population < 3500) { ratioAuto = 1.08; labelAuto = "8%"; }
      else if (population < 10000) { ratioAuto = 1.06; labelAuto = "6%"; }
      else if (population < 20000) { ratioAuto = 1.04; labelAuto = "4%"; }

      const nbConseillers = conseillersTranches.find(t => population <= t.max).nb;
      const nbMaxAdjoints = Math.floor(nbConseillers * 0.30);
      const baseMaire = (remunerationData.maire.find(t => population <= t.max).montant) * ratioAuto;
      const baseAdjoint = (remunerationData.adjoint.find(t => population <= t.max).montant) * ratioAuto;
      const baseConseiller = population >= 100000 ? 246.63 : 0;

      currentData = {
        population, nbConseillers, nbMaxAdjoints, nbAdjointsActuel: nbMaxAdjoints,
        indemniteMaileLegale: baseMaire, indemniteAdjointLegale: baseAdjoint,
        indemniteConseillerLegale: baseConseiller, indemniteMaileActuelle: baseMaire,
        indemniteAdjointActuelle: baseAdjoint, indemniteConseillerActuelle: baseConseiller,
        majoration: 0, majorationType: null, tauxAuto: labelAuto
      };
      
      document.getElementById('advanced-mode-toggle').classList.remove('hidden');
      displayResults();
    }

    function toggleAdvancedMode() {
      advancedMode = !advancedMode;
      const btn = document.getElementById('toggle-advanced-btn');
      btn.textContent = advancedMode ? 'Revenir au mode simple' : 'Basculer vers le mode avancé';
      if (!advancedMode) calculateRemuneration(); // Reset
      displayResults();
    }

    function updateVal(key, val) {
      currentData[key] = parseFloat(val);
      displayResults();
    }

    function selectMaj(type, pct) {
      if (currentData.majorationType === type) { currentData.majoration = 0; currentData.majorationType = null; }
      else { currentData.majoration = pct; currentData.majorationType = type; }
      displayResults();
    }

    function displayResults() {
      if (!currentData) return;
      const d = currentData;
      const majTotal = 1 + (d.majoration / 100);
      
      // Calcul enveloppe max basée sur les montants légaux (incluant la strate auto)
      const envMax = d.indemniteMaileLegale + (d.indemniteAdjointLegale * d.nbMaxAdjoints) + (d.indemniteConseillerLegale * (d.nbConseillers - 1 - d.nbMaxAdjoints));
      
      const mFinal = d.indemniteMaileActuelle * majTotal;
      const aFinal = d.indemniteAdjointActuelle * majTotal;
      const cFinal = d.indemniteConseillerActuelle * majTotal;
      const nbC = d.nbConseillers - 1 - d.nbAdjointsActuel;
      const budgetTotal = mFinal + (aFinal * d.nbAdjointsActuel) + (cFinal * nbC);

      const res = document.getElementById('result-remuneration');
      res.innerHTML = `
        <div class="result-animation space-y-6">
          <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-6">
            <h3 class="font-bold text-blue-900 mb-2">Données de la commune</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <p>Population: <b>${d.population.toLocaleString()}</b> ${d.tauxAuto ? `<span class="text-green-600">(+${d.tauxAuto} incl.)</span>` : ''}</p>
                <p>Enveloppe Max: <b>${envMax.toLocaleString('fr-FR')} €</b></p>
            </div>
          </div>

          <div class="bg-white border rounded-lg p-6 shadow-sm space-y-6">
            <div>
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Maire</span>
                    <span class="font-bold text-blue-900">${mFinal.toLocaleString('fr-FR', {minimumFractionDigits:2})} €</span>
                </div>
                ${advancedMode ? `<input type="range" min="0" max="${d.indemniteMaileLegale}" step="1" value="${d.indemniteMaileActuelle}" class="slider" oninput="updateVal('indemniteMaileActuelle', this.value)">` : ''}
            </div>

            <div>
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Adjoints (x${d.nbAdjointsActuel})</span>
                    <span class="font-bold text-blue-900">${aFinal.toLocaleString('fr-FR', {minimumFractionDigits:2})} €</span>
                </div>
                ${advancedMode ? `
                    <div class="space-y-3">
                        <label class="text-xs text-gray-500">Nombre d'adjoints</label>
                        <input type="range" min="1" max="${d.nbMaxAdjoints}" value="${d.nbAdjointsActuel}" class="slider" oninput="updateVal('nbAdjointsActuel', this.value)">
                        <label class="text-xs text-gray-500">Indemnité par adjoint</label>
                        <input type="range" min="0" max="${d.indemniteMaileLegale}" step="1" value="${d.indemniteAdjointActuelle}" class="slider" oninput="updateVal('indemniteAdjointActuelle', this.value)">
                    </div>
                ` : ''}
            </div>

            <div>
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Conseillers (x${nbC})</span>
                    <span class="font-bold ${cFinal > 0 ? 'text-blue-900' : 'text-gray-300'}">${cFinal.toLocaleString('fr-FR', {minimumFractionDigits:2})} €</span>
                </div>
                ${advancedMode ? `<input type="range" min="0" max="246" step="1" value="${d.indemniteConseillerActuelle}" class="slider" oninput="updateVal('indemniteConseillerActuelle', this.value)">` : ''}
            </div>
          </div>

          ${advancedMode ? `
          <div class="bg-yellow-50 border-l-4 border-yellow-500 rounded-lg p-6">
            <h3 class="font-bold text-yellow-900 mb-3">Majorations Spécifiques</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              <label class="flex items-center"><input type="checkbox" class="mr-2" ${d.majorationType==='dept'?'checked':''} onchange="selectMaj('dept', 25)"> Chef-lieu dép. (+25%)</label>
              <label class="flex items-center"><input type="checkbox" class="mr-2" ${d.majorationType==='arrond'?'checked':''} onchange="selectMaj('arrond', 20)"> Chef-lieu arrond. (+20%)</label>
              <label class="flex items-center"><input type="checkbox" class="mr-2" ${d.majorationType==='canton'?'checked':''} onchange="selectMaj('canton', 15)"> Chef-lieu canton (+15%)</label>
              <label class="flex items-center"><input type="checkbox" class="mr-2" ${d.majorationType==='tour'?'checked':''} onchange="selectMaj('tour', ${d.population<5000?50:25})"> Station tourisme (+${d.population<5000?50:25}%)</label>
            </div>
          </div>
          ` : ''}

          <div class="bg-[#111F49] text-white rounded-lg p-6 text-center shadow-lg">
            <p class="text-sm opacity-80">Coût total mensuel</p>
            <p class="text-3xl font-bold">${budgetTotal.toLocaleString('fr-FR', {minimumFractionDigits:2})} €</p>
            ${budgetTotal > (envMax * majTotal) + 1 ? `<p class="text-xs text-red-400 mt-2">Attention : Dépassement de l'enveloppe légale</p>` : ''}
          </div>
        </div>
      `;
      res.classList.remove('hidden');
    }
  </script>
 </body>
</html>
